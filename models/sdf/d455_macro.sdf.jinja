<!-- Macro to add an Intel Realsense D455 {-->
{%- macro d455_macro(namespace, camera_name, camera_suffix, parent_link, x, y, z, roll, pitch, yaw) -%}

{# -- set constants -- #}
{%- set pi = 3.14159265359 -%}
{%- set rad87 = 87 * pi / 180 -%}
{%- set rad90 = 90 * pi / 180 -%}
{%- set rad180 = 180 * pi / 180 -%}

{# -- frame names -- #}
{%- set frame_fcu = namespace + "/fcu" -%}

<link name="{{ camera_name }}_link">
    <pose>0.086 0 -0.05 3.1415 0 1.5708</pose>
    <inertial>
        <mass>0.072</mass>
        <inertia>
            <ixx>0.00388124</ixx>
            <ixy>1.0842e-19</ixy>
            <ixz>-1.0842e-19</ixz>
            <iyy>0.00049894</iyy>
            <iyz>2.71051e-20</iyz>
            <izz>0.00387926</izz>
        </inertia>
    </inertial>

    <visual name="{{ camera_name }}_visual">
        <pose>0 0 0 0 0 0</pose>
        <geometry>
            <mesh>
                <uri>model://mrs_robots_description/meshes/custom/d455/d455.stl</uri>
                <scale>0.001 0.001 0.001</scale>
            </mesh>
        </geometry>
    </visual>

    <collision name="{{ camera_name }}_collision">
        <pose>0 0 0 0 0 0</pose>
        <geometry>
            <box>
                <size>0.026 0.124 0.029</size>
            </box>
        </geometry>
        <surface>
            <contact>
                <ode>
                    <kp>1e+13</kp>
                    <kd>1</kd>
                </ode>
            </contact>
            <friction>
                <ode>
                    <mu2>1</mu2>
                    <fdir1>0 0 0</fdir1>
                </ode>
            </friction>
        </surface>
    </collision>
    <self_collide>0</self_collide>
    <enable_wind>0</enable_wind>
    <kinematic>0</kinematic>
    <gravity>1</gravity>

    <sensor name='{{ namespace}}/down_rgbd_color' type='camera'>
        <camera name='{{ namespace}}/down_rgbd_color'>
            <horizontal_fov>{{ rad87 }}</horizontal_fov>
            <image>
                <width>1280</width>
                <height>720</height>
                <format>RGB_INT8</format>
            </image>
            <clip>
                <near>0.2</near>
                <far>10</far>
            </clip>
            <distortion>
                <k1>0.0</k1>
                <k2>0.0</k2>
                <k3>0.0</k3>
                <p1>0.0</p1>
                <p2>0.0</p2>
            </distortion>
            <lens>
                <intrinsics>
                    <fx>525</fx>
                    <fy>525</fy>
                    <cx>367.5</cx>
                    <cy>248</cy>
                </intrinsics>
            </lens>
        </camera>
        <always_on>1</always_on>
        <update_rate>30</update_rate>
        <visualize>0</visualize>
        <pose>0 0 0 {{ pi }} {{ -rad90 }} {{ rad90 }}</pose>
    </sensor>

    <sensor name='{{ namespace}}/down_rgbd_infra_stereo' type='multicamera'>
        <always_on>1</always_on>
        <update_rate>60</update_rate>
        <visualize>0</visualize>
        <pose>0.15115 0.0475 -0.0605 0 -0 0</pose>
        <camera name='{{ namespace}}/down_rgbd_ired1'>
            <horizontal_fov>{{ rad87 }}</horizontal_fov>
            <image>
                <width>1280</width>
                <height>720</height>
                <format>L_INT8</format>
            </image>
            <clip>
                <near>0.2</near>
                <far>10</far>
            </clip>
            <distortion>
                <k1>0.0</k1>
                <k2>0.0</k2>
                <k3>0.0</k3>
                <p1>0.0</p1>
                <p2>0.0</p2>
            </distortion>
            <lens>
                <intrinsics>
                    <fx>525</fx>
                    <fy>525</fy>
                    <cx>367.5</cx>
                    <cy>248</cy>
                </intrinsics>
            </lens>
        </camera>
        <always_on>1</always_on>
        <update_rate>30</update_rate>
        <visualize>0</visualize>
        <pose>0 0 0 {{ pi }} {{ -rad90 }} {{ rad90 }}</pose>

        <camera name='{{ namespace}}/down_rgbd_ired2'>
            <horizontal_fov>{{ rad87 }}</horizontal_fov>
            <image>
                <width>1280</width>
                <height>720</height>
                <format>L_INT8</format>
            </image>
            <clip>
                <near>0.2</near>
                <far>10</far>
            </clip>
            <distortion>
                <k1>0.0</k1>
                <k2>0.0</k2>
                <k3>0.0</k3>
                <p1>0.0</p1>
                <p2>0.0</p2>
            </distortion>
            <lens>
                <intrinsics>
                    <fx>525</fx>
                    <fy>525</fy>
                    <cx>367.5</cx>
                    <cy>248</cy>
                </intrinsics>
            </lens>
        </camera>
    </sensor>

    <sensor name='{{ namespace}}/down_rgbd_aligned_depth_to_color' type='depth'>
        <camera name='{{ namespace}}/down_rgbd_aligned_depth_to_color'>
            <horizontal_fov>{{ rad87 }}</horizontal_fov>
            <image>
                <width>1280</width>
                <height>800</height>
            </image>
            <clip>
                <near>0.2</near>
                <far>10</far>
            </clip>
            <distortion>
                <k1>0.0</k1>
                <k2>0.0</k2>
                <k3>0.0</k3>
                <p1>0.0</p1>
                <p2>0.0</p2>
            </distortion>
            <lens>
                <intrinsics>
                    <fx>525</fx>
                    <fy>525</fy>
                    <cx>367.5</cx>
                    <cy>248</cy>
                </intrinsics>
            </lens>
        </camera>
        <always_on>1</always_on>
        <update_rate>15</update_rate>
        <visualize>0</visualize>
        <pose>0 0 0 {{ pi }} {{ -rad90 }} {{ rad90 }}</pose>
    </sensor>
</link>

<plugin name='down_rgbd_plugin' filename='libMRSGazeboRealsensePlugin.so'>
    <camera_name>down_rgbd</camera_name>
    <camera_suffix></camera_suffix>
    <useRealistic>0</useRealistic>
    <noisePerMeter>0.2</noisePerMeter>
    <minNoiseDistance>4.0</minNoiseDistance>
    <perlinEmptyThreshold>0.8</perlinEmptyThreshold>
    <perlinEmptySpeed>0.2</perlinEmptySpeed>
    <imageScaling>4</imageScaling>
    <blurSize>15</blurSize>
    <erosionSize>5</erosionSize>
    <parentFrameName>{{ frame_fcu }}</parentFrameName>
    <x>{{ x }}</x>
    <y>{{ y }}</y>
    <z>{{ z }}</z>
    <roll>{{ roll }}</roll>
    <pitch>{{ pitch }}</pitch>
    <yaw>{{ yaw }}</yaw>
</plugin>

<joint name="{{ camera_name }}_joint" type="fixed">
    <parent>{{ parent_link }}</parent>
    <child>{{ camera_name }}_link</child>
    <pose>0 0 0 0 0 0</pose>
</joint>

<frame name='{{ camera_name }}accel_optical_joint' attached_to='{{ camera_name }}accel_frame'>
<pose>0 0 0 -1.5708 -0 -1.5708</pose>
</frame>

<frame name='{{ camera_name }}accel_optical_frame' attached_to='{{ camera_name }}accel_optical_joint'/>

<frame name='{{ camera_name }}accel_joint' attached_to='{{ camera_name }}link'>
<pose>-0.01602 -0.03022 0.0074 0 -0 0</pose>
</frame>

<frame name='{{ camera_name }}accel_frame' attached_to='{{ camera_name }}accel_joint'/>

<frame name='{{ camera_name }}color_optical_joint' attached_to='{{ camera_name }}color_frame'>
<pose>0 0 0 -1.5708 -0 -1.5708</pose>
</frame>

<frame name='{{ camera_name }}color_optical_frame' attached_to='{{ camera_name }}color_optical_joint'/>

<frame name='{{ camera_name }}color_joint' attached_to='{{ camera_name }}link'>
<pose>0 -0.059 0 0 -0 0</pose>
</frame>

<frame name='{{ camera_name }}color_frame' attached_to='{{ camera_name }}color_joint'/>

<frame name='{{ camera_name }}depth_optical_joint' attached_to='{{ camera_name }}depth_frame'>
<pose>0 0 0 -1.5708 -0 -1.5708</pose>
</frame>

<frame name='{{ camera_name }}depth_optical_frame' attached_to='{{ camera_name }}depth_optical_joint'/>

<frame name='{{ camera_name }}depth_joint' attached_to='{{ camera_name }}link'>
<pose>0 0 0 0 -0 0</pose>
</frame>

<frame name='{{ camera_name }}depth_frame' attached_to='{{ camera_name }}depth_joint'/>

<frame name='{{ camera_name }}imu_optical_joint' attached_to='{{ camera_name }}gyro_optical_frame'>
<pose>0 0 0 0 -0 0</pose>
</frame>

<frame name='{{ camera_name }}imu_optical_frame' attached_to='{{ camera_name }}imu_optical_joint'/>

<frame name='{{ camera_name }}gyro_optical_joint' attached_to='{{ camera_name }}gyro_frame'>
<pose>0 0 0 -1.5708 -0 -1.5708</pose>
</frame>

<frame name='{{ camera_name }}gyro_optical_frame' attached_to='{{ camera_name }}gyro_optical_joint'/>

<frame name='{{ camera_name }}gyro_joint' attached_to='{{ camera_name }}link'>
<pose>-0.01602 -0.03022 0.0074 0 -0 0</pose>
</frame>

<frame name='{{ camera_name }}gyro_frame' attached_to='{{ camera_name }}gyro_joint'/>

<frame name='{{ camera_name }}infra1_optical_joint' attached_to='{{ camera_name }}infra1_frame'>
<pose>0 0 0 -1.5708 -0 -1.5708</pose>
</frame>

<frame name='{{ camera_name }}infra1_optical_frame' attached_to='{{ camera_name }}infra1_optical_joint'/>

<frame name='{{ camera_name }}infra1_joint' attached_to='{{ camera_name }}link'>
<pose>0 0 0 0 -0 0</pose>
</frame>

<frame name='{{ camera_name }}infra1_frame' attached_to='{{ camera_name }}infra1_joint'/>

<frame name='{{ camera_name }}infra2_optical_joint' attached_to='{{ camera_name }}infra2_frame'>
<pose>0 0 0 -1.5708 -0 -1.5708</pose>
</frame>

<frame name='{{ camera_name }}infra2_optical_frame' attached_to='{{ camera_name }}infra2_optical_joint'/>

<frame name='{{ camera_name }}infra2_joint' attached_to='{{ camera_name }}link'>
<pose>0 -0.095 0 0 -0 0</pose>
</frame>

<frame name='{{ camera_name }}infra2_frame' attached_to='{{ camera_name }}infra2_joint'/>

<frame name='{{ camera_name }}link_joint' attached_to='{{ camera_name }}bottom_screw_frame'>
<pose>0.01115 0.0475 0.0145 0 -0 0</pose>
</frame>

<frame name='{{ camera_name }}link' attached_to='{{ camera_name }}link_joint'/>

<frame name='{{ camera_name }}joint' attached_to='{{ parent_link }}'>
<pose>0.14 0 -0.075 0 -0 0</pose>
</frame>

<frame name='{{ camera_name }}bottom_screw_frame' attached_to='{{ camera_name }}joint'/>

<frame name='{{ camera_name }}link' attached_to='{{ parent_link }}'>
<pose>0 0 0 0 0 0</pose>
</frame>
{%- endmacro -%}